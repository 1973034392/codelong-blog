# Redis BitMap 与流量统计

Redis 的 **BitMap (位图)** 并不是一个独立的数据类型，而是对 String 类型的一种扩展和一系列位操作命令的集合。它允许您将一个字符串看作是一个由二进制位（0 或 1）组成的数组，并对这些位进行独立的设置和查询。

由于其极高的空间效率，BitMap 在处理海量数据的布尔状态（例如，用户是否在线、是否签到、是否看过某篇文章）时，表现得非常出色。

## 核心原理与命令

- **数据结构**：BitMap 本质上是一个字节数组（String），Redis 提供了直接操作其二进制位的接口。
- **`SETBIT key offset value`**：设置 `key` 对应 BitMap 中 `offset` (偏移量) 位置上的位为 `value` (0 或 1)。这是最核心的写入操作。
- **`GETBIT key offset`**：获取 `key` 对应 BitMap 中 `offset` 位置上的位的值。
- **`BITCOUNT key [start end]`**：统计 BitMap 中值为 1 的位的数量。可以指定字节范围进行统计。
- **`BITOP operation destkey key [key ...]`**：对一个或多个 BitMap 执行位运算（AND, OR, XOR, NOT），并将结果保存到 `destkey`。

## 如何使用 BitMap 进行流量统计？

这是 BitMap 最经典的用途，尤其是需要对用户进行去重统计的场景。

### 1. 统计日活跃用户 (DAU)

假设我们的系统有数亿用户，并且每个用户都有一个从 0 开始自增的数字 ID。

- **记录用户登录**：当一个 ID 为 `userId` 的用户在某一天（例如 `2025-08-12`）登录时，我们执行一个 `SETBIT` 命令。

  - **Key**: 可以是 `dau:2025-08-12` (Daily Active Users for 2025-08-12)。
  - **Offset**: 就是用户的 `userId`。
  - **Value**: `1`，表示该用户今天活跃。

  ```
  # 用户 ID 为 10086 的用户在 2025-08-12 登录了
  SETBIT dau:2025-08-12 10086 1
  
  # 用户 ID 为 666 的用户也登录了
  SETBIT dau:2025-08-12 666 1
  ```

  即使同一个用户当天多次登录，`SETBIT` 命令也只是反复将同一个位置设为 1，完美实现了**自动去重**。

- **统计 DAU**：想知道今天总共有多少独立用户登录？一个 `BITCOUNT` 命令就够了。

  ```
  BITCOUNT dau:2025-08-12
  ```

  这个命令会返回 `dau:2025-08-12` 这个 key 中所有值为 1 的位的数量，即当天的独立用户总数。

### 2. 统计月活跃用户 (MAU)

要计算月活，我们需要用到 `BITOP` 命令，它可以对多个 BitMap 进行位运算。

1. **合并日活数据**：将一个月内所有日期的 DAU BitMap 进行 **OR (或)** 运算。只要一个用户在一个月内任何一天登录过，结果 BitMap 中对应的位就会是 1。

   ```
   # 计算2025年8月的月活
   BITOP OR mau:2025-08 dau:2025-08-01 dau:2025-08-02 ... dau:2025-08-31
   ```

2. **统计 MAU**：对合并后的 `mau:2025-08` 这个 key 执行 `BITCOUNT`。

   ```
   BITCOUNT mau:2025-08
   ```

### 3. 用户连续登录/留存分析

想知道某个用户是否连续 3 天登录？用 `GETBIT` 就行。

```
# 检查用户 10086 是否在 8月10日、11日、12日都登录了
GETBIT dau:2025-08-10 10086
GETBIT dau:2025-08-11 10086
GETBIT dau:2025-08-12 10086
```

如果三次查询结果都为 1，则说明该用户实现了连续 3 天登录。

## 优缺点总结

| 特性     | Redis BitMap                                                 |
| -------- | ------------------------------------------------------------ |
| **优点** | ✅ **极高的空间效率**：存储 1 亿用户的日活状态，仅需约 12.5 MB 内存 (100,000,000 / 8 / 1024 / 1024)。 |
|          | ✅ **性能优异**：位操作指令执行速度非常快，`BITCOUNT` 算法也很高效。 |
|          | ✅ **操作简单**：命令清晰，逻辑简单，非常适合做大规模去重统计。 |
| **缺点** | ❌ **Offset 必须是数字**：用户的标识必须是整数。如果用户 ID 是字符串（如 UUID），需要先映射成整数 ID。 |
|          | ❌ **稀疏数据问题**：BitMap 的大小由 `offset` 的最大值决定。如果用户 ID 分布非常稀疏（例如只有 ID 为 1 和 ID 为 1 亿的用户），Redis 仍需分配约 12.5 MB 的空间，中间部分会被浪费。 |

## 结论

总而言之，Redis BitMap 提供了一种极其节省空间且性能卓越的方式来处理海量用户的布尔状态数据。它是实现大规模日活/月活统计、用户签到、在线状态跟踪等场景的利器。
